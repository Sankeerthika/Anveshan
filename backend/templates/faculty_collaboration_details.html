{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width:1100px;">
    <div class="card" style="padding:24px; margin-top:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:16px;">
            <div style="display:flex; align-items:center; gap:12px;">
                <a href="{{ url_for('collaboration.faculty_dashboard') if user.role == 'faculty' else url_for('collaboration.community') }}" class="btn secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                <div style="display:flex; gap:8px;">
                    <span class="badge bg-info text-dark">{{ collab.collaboration_type|title }}</span>
                    <span class="badge bg-secondary">{{ collab.audience|replace('_', ' ')|title }}</span>
                    {% if collab.status == 'closed' %}
                        <span class="badge bg-danger">Closed</span>
                    {% endif %}
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <img src="{{ url_for('static', filename='uploads/' + (collab.faculty_photo or '')) }}" alt="" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                <div>
                    <div style="font-weight:700; color:#111827;">{{ collab.faculty_name }}</div>
                    <div style="color:#6b7280; font-size:0.85rem;">Lead Faculty</div>
                </div>
            </div>
        </div>
        <div style="margin-top:18px;">
            <h1 style="margin:0; font-size:2rem; color:#1f2937;">{{ collab.title }}</h1>
            <p style="color:#4b5563; margin-top:10px;">{{ collab.description|replace('\n', '<br>')|safe }}</p>
        </div>
        <div style="display:flex; gap:16px; flex-wrap:wrap; margin-top:16px;">
            {% set must = (collab.required_skills_must|default('')) %}
            {% set nice = (collab.required_skills_nice|default('')) %}
            {% set agg = (collab.required_skills|default('')) %}
            {% if must or nice or agg %}
            <div class="card" style="padding:16px; flex:1;">
                <div style="font-weight:700; margin-bottom:8px;">Required Skills</div>
                <div style="display:flex; flex-wrap:wrap; gap:8px;">
                    {% for skill in (must or agg).split(',') if skill.strip() %}
                        <span class="badge bg-light text-dark" style="border:1px solid #e5e7eb;">{{ skill.strip() }}</span>
                    {% endfor %}
                    {% for skill in nice.split(',') if skill.strip() %}
                        <span class="badge bg-light text-dark" style="border:1px solid #e5e7eb; opacity:0.8;">{{ skill.strip() }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            <div class="card" style="padding:16px; min-width:220px;">
                <div style="display:flex; justify-content:space-between;">
                    <div>
                        <div style="color:#6b7280; font-size:0.85rem;">Faculty</div>
                        <div style="font-weight:700;">{{ collab.current_faculty }} / {{ collab.max_faculty if collab.max_faculty > 0 else '∞' }}</div>
                    </div>
                    <div>
                        <div style="color:#6b7280; font-size:0.85rem;">Students</div>
                        <div style="font-weight:700;">{{ collab.current_students }} / {{ collab.max_students if collab.max_students > 0 else '∞' }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if user.id != collab.faculty_id %}
    <div class="card" style="padding:24px; margin-top:16px;">
        <div style="display:flex; align-items:center; justify-content:space-between;">
            <h3 style="margin:0;">Join Collaboration</h3>
        </div>
        <div style="margin-top:12px;">
            {% if collab.my_status == 'accepted' %}
                <div class="alert alert-success"><i class="fas fa-check-circle"></i> You are a collaborator on this project!</div>
            {% elif collab.my_status == 'pending' %}
                <div class="alert alert-warning"><i class="fas fa-clock"></i> Your request is pending approval.</div>
            {% elif collab.my_status == 'rejected' %}
                <div class="alert alert-danger"><i class="fas fa-times-circle"></i> Your request was declined.</div>
            {% else %}
                {% if can_apply %}
                    <form action="{{ url_for('collaboration.apply_faculty_collaboration', collab_id=collab.id) }}" method="POST">
                        <label for="message" style="display:block; font-weight:600; margin-bottom:6px;">Why are you a good fit?</label>
                        <textarea name="message" id="message" rows="3" class="form-control" required></textarea>
                        <div style="margin-top:12px;">
                            <button type="submit" class="btn-primary"><i class="fas fa-paper-plane"></i> Apply Now</button>
                        </div>
                    </form>
                {% else %}
                    <div class="alert alert-info"><i class="fas fa-lock"></i> Application Unavailable: <strong>{{ rejection_reason }}</strong></div>
                {% endif %}
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if user.id == collab.faculty_id %}
    <div style="display:grid; grid-template-columns: 1.3fr 1fr; gap:16px; margin-top:16px;">
        <div class="card" style="padding:24px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">Manage Collaboration</h3>
                {% if collab.status != 'closed' %}
                <form action="{{ url_for('collaboration.close_faculty_collaboration', collab_id=collab.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to close this collaboration? This cannot be undone.');">
                    <button type="submit" class="btn" style="background-color:#e74c3c; color:#fff;"><i class="fas fa-lock"></i> Close Collaboration</button>
                </form>
                {% endif %}
            </div>
            <p style="color:#6b7280; margin-top:8px;">Once you close the collaboration, no new applications will be accepted.</p>
            {% if requests %}
            <div style="margin-top:16px;">
                <div style="font-weight:700; margin-bottom:10px;">Pending Requests</div>
                <div style="display:grid; gap:12px;">
                    {% for req in requests %}
                    <div class="card" style="padding:16px; display:flex; justify-content:space-between; align-items:flex-start;">
                        <div style="flex:1; margin-right:12px;">
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
                                <strong>{{ req.user_name }}</strong>
                                <span class="badge bg-light text-dark" style="border:1px solid #e5e7eb;">{{ req.user_role|title }}</span>
                            </div>
                            <div style="color:#4b5563; font-size:0.95rem;">"{{ req.message }}"</div>
                            <div style="color:#6b7280; font-size:0.85rem; margin-top:6px;"><strong>Skills:</strong> {{ req.user_skills }}</div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <form action="{{ url_for('collaboration.manage_faculty_request', req_id=req.id, action='accepted') }}" method="POST">
                                <button type="submit" class="btn">Accept</button>
                            </form>
                            <form action="{{ url_for('collaboration.manage_faculty_request', req_id=req.id, action='rejected') }}" method="POST">
                                <button type="submit" class="btn" style="background-color:#e74c3c; color:#fff;">Reject</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        <div class="card" style="padding:24px;">
            <h3 style="margin-top:0;">Recommended Collaborators</h3>
            {% if recommended_faculty %}
            <div style="display:grid; gap:12px;">
                {% for prof in recommended_faculty %}
                <div class="card" style="padding:12px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:600;">{{ prof.name }}</div>
                        <div style="color:#6b7280; font-size:0.9rem;">Skills: {{ prof.skills }}</div>
                        <div style="color:#1C4980; font-size:0.9rem; font-weight:600;">Match: {{ prof.match_percent }}%</div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <a href="{{ url_for('collaboration.view_profile', profile_id=prof.id) }}" class="btn">View Profile</a>
                        <form action="{{ url_for('collaboration.invite_faculty_user', collab_id=collab.id, user_id=prof.id) }}" method="POST">
                            <button type="submit" class="btn">Invite</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="color:#6b7280;">No recommendations yet.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
    <div class="card" style="padding:24px; margin-top:16px;">
        <h3 style="margin-top:0;">Members</h3>
        <div style="display:grid; gap:10px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <span class="badge bg-secondary">Owner</span>
                <strong>{{ collab.faculty_name }}</strong>
            </div>
            {% if accepted_users %}
                {% for m in accepted_users %}
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="badge bg-light text-dark" style="border:1px solid #e5e7eb;">{{ m.role|title }}</span>
                    <strong>{{ m.name }}</strong>
                    <a href="mailto:{{ m.email }}" class="btn-secondary" style="padding:4px 8px;">Email</a>
                </div>
                {% endfor %}
            {% else %}
                <p style="color:#6b7280;">No accepted members yet.</p>
            {% endif %}
        </div>
    </div>

    <div class="card" style="padding:24px; margin-top:16px;">
        <h3 style="margin-top:0;">Discussion</h3>
        {% if collab_comments %}
        <div style="display:grid; gap:12px; margin-bottom:12px;">
            {% for c in collab_comments %}
            <div class="card" style="padding:12px;">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <strong>{{ c.user_name }}</strong>
                    <span style="color:#6b7280; font-size:0.85rem;">{{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
                <div style="color:#374151;">{{ c.content }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="color:#6b7280;">No messages yet.</p>
        {% endif %}
        {% if can_comment and collab.status != 'closed' %}
        <form action="{{ url_for('collaboration.add_collaboration_comment', collab_id=collab.id) }}" method="POST">
            <textarea name="content" rows="3" class="form-control" placeholder="Type a message..." required></textarea>
            <div style="margin-top:10px;">
                <button type="submit" class="btn-primary"><i class="fas fa-paper-plane"></i> Send</button>
            </div>
        </form>
        {% else %}
        <p style="color:#6b7280; font-size:0.9rem;">Only the owner and accepted collaborators can post.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
